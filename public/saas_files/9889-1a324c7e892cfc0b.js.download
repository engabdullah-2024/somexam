"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9889],{19889:(e,t,n)=>{n.d(t,{J:()=>l,RealTimeNotificationProvider:()=>d});var o=n(95155),i=n(12115),r=n(22100),c=n(26715),a=n(56671),u=n(67737);let s=(0,i.createContext)(null);function l(){let e=(0,i.useContext)(s);return e||{isConnected:!1,notifications:[],settings:{enabled:!1,sound:!1,voice:!1,browser:!1,voiceLanguage:"en-US",voiceSpeed:1,voicePitch:1},updateSettings:()=>{},clearNotifications:()=>{},unreadCount:0,updateDocumentTitle:()=>{}}}function d(e){let{children:t}=e,{user:n,isAuthenticated:l}=(0,r.A)(),d=(0,c.jE)(),[f,w]=(0,i.useState)(!1),[m,p]=(0,i.useState)([]),[v,h]=(0,i.useState)(0),y=(0,i.useRef)(null),g=(0,i.useRef)(null),b=(0,i.useRef)(null),S=(0,i.useRef)("");(0,i.useEffect)(()=>{{S.current||(S.current=document.title);let e=new MutationObserver(()=>{let e=document.title;e.includes("(")&&e.includes(")")||(S.current=e)});return e.observe(document.querySelector("title")||document.head,{childList:!0,characterData:!0,subtree:!0}),()=>e.disconnect()}},[]);let C=e=>{{let t=S.current||document.title.replace(/^\(\d+\)\s*/,"");e>0?document.title="(".concat(e,") ").concat(t):document.title=t}},[N,T]=(0,i.useState)(()=>{{let e=localStorage.getItem("notification-settings"),t={enabled:!0,sound:!0,voice:!1,browser:!0,voiceLanguage:"en-US",voiceSpeed:1,voicePitch:1};return e?{...t,...JSON.parse(e)}:t}});(0,i.useEffect)(()=>{localStorage.setItem("notification-settings",JSON.stringify(N))},[N]),(0,i.useEffect)(()=>{g.current=new(window.AudioContext||window.webkitAudioContext),b.current=window.speechSynthesis},[]),(0,i.useEffect)(()=>{N.browser&&(0,u.KO)()&&"default"===(0,u.hH)()&&(0,u.mT)()},[N.browser]);let k=async()=>{if(N.sound)try{let e=new Audio("/sounds/notification.mp3");e.volume=.6;let t=async e=>new Promise((t,n)=>{e.onloadeddata=()=>{e.play().then(()=>t()).catch(e=>n(e))},e.onerror=()=>n(Error("Audio failed to load")),e.load()});try{await t(e)}catch(e){for(let n of(console.warn("Primary notification sound failed, trying fallbacks:",e),["/sounds/notification.wav","/sounds/notification.ogg","https://www.soundjay.com/misc/sounds/notification-sound-7062.mp3","https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-one/notification_simple-01.mp3"]))try{let e=new Audio(n);e.volume=.6,await t(e);break}catch(e){console.warn("Fallback sound failed: ".concat(n),e)}}}catch(e){console.warn("All notification sounds failed, using browser default:",e);try{g.current||(g.current=new(window.AudioContext||window.webkitAudioContext)),"suspended"===g.current.state&&await g.current.resume();let e=g.current.createOscillator(),t=g.current.createGain();e.connect(t),t.connect(g.current.destination),e.frequency.setValueAtTime(800,g.current.currentTime),t.gain.setValueAtTime(.2,g.current.currentTime),t.gain.exponentialRampToValueAtTime(.01,g.current.currentTime+.3),e.start(g.current.currentTime),e.stop(g.current.currentTime+.3)}catch(e){console.warn("Even fallback beep failed:",e)}}},E=e=>{if(N.voice&&b.current)try{b.current.cancel();let t=new SpeechSynthesisUtterance(e);t.lang=N.voiceLanguage,t.rate=N.voiceSpeed,t.pitch=N.voicePitch,t.volume=.8,b.current.speak(t)}catch(e){console.warn("Failed to speak notification:",e)}},A=e=>{var t,n;if(!N.browser||!(0,u.cn)())return;let o="".concat((null===(t=e.sender)||void 0===t?void 0:t.firstName)||"Someone"," ").concat(e.message),i={body:"Click to view",icon:(null===(n=e.sender)||void 0===n?void 0:n.avatar)||"/icon-192x192.png",badge:"/icon-192x192.png",tag:e.id,requireInteraction:!1,silent:!1},r=(0,u.dL)(o,i);r&&(r.onclick=()=>{window.focus(),e.actionUrl&&(window.location.href=e.actionUrl),r.close()},setTimeout(()=>{r.close()},5e3))},x=e=>{var t;if(!N.enabled)return;p(t=>[e,...t.slice(0,9)]),h(e=>e+1),k(),E("".concat((null===(t=e.sender)||void 0===t?void 0:t.firstName)||"Someone"," ").concat(e.message)),A(e);let n=e.sender?"".concat(e.sender.firstName," ").concat(e.sender.lastName):"Someone";a.o.success("".concat(n," ").concat(e.message),{action:e.actionUrl?{label:"View",onClick:()=>window.location.href=e.actionUrl}:void 0,duration:5e3}),d.invalidateQueries({queryKey:["user-notifications"]}),d.invalidateQueries({queryKey:["notifications","unread-count"]}),d.refetchQueries({queryKey:["user-notifications","unread-count"]})};return(0,i.useEffect)(()=>{C(v)},[v]),(0,i.useEffect)(()=>{if(!l)return;let e=setInterval(async()=>{try{var e;let t=d.getQueryData(["user-notifications","unread-count"]),n=null===(e=d.getQueryState(["user-notifications","unread-count"]))||void 0===e?void 0:e.dataUpdatedAt;if(n&&Date.now()-n<9e4)return;(null==t?void 0:t.unreadCount)!==void 0&&t.unreadCount!==v&&(h(t.unreadCount),C(t.unreadCount))}catch(e){console.warn("Failed to sync unread count:",e)}},12e4);return()=>clearInterval(e)},[l,d,v]),(0,i.useEffect)(()=>{let e=d.getQueryData(["user-notifications","unread-count"]);(null==e?void 0:e.unreadCount)!==void 0&&e.unreadCount!==v&&(h(e.unreadCount),C(e.unreadCount))},[d,v]),(0,i.useEffect)(()=>{if(!l||!(null==n?void 0:n.id)||!N.enabled){y.current&&(y.current.close(),y.current=null),w(!1);return}let e=null,t=0,o=()=>{y.current&&(y.current.close(),y.current=null);try{let i=new EventSource("".concat("https://api.dugsiiye.com/api","/user-notifications/stream"),{withCredentials:!0});y.current=i,i.onopen=()=>{w(!0),t=0},i.onmessage=e=>{try{let t=JSON.parse(e.data);"notification"===t.type?x(t.notification):"ping"===t.type||t.type}catch(e){console.warn("Failed to parse notification event:",e)}},i.onerror=r=>{if(console.warn("Real-time notification connection error:",r),w(!1),i.close(),t<5&&l&&(null==n?void 0:n.id)&&N.enabled){t++;let n=Math.min(1e3*Math.pow(2,t-1),3e4);e=setTimeout(()=>{o()},n)}else t>=5&&console.warn("Max reconnection attempts reached. Please refresh the page.")}}catch(e){console.error("Failed to create SSE connection:",e),w(!1)}};return o(),()=>{e&&clearTimeout(e),y.current&&(y.current.close(),y.current=null),w(!1)}},[l,null==n?void 0:n.id,N.enabled]),(0,o.jsx)(s.Provider,{value:{isConnected:f,notifications:m,settings:N,updateSettings:e=>{T(t=>({...t,...e}))},clearNotifications:()=>{p([])},unreadCount:v,updateDocumentTitle:C},children:t})}},67737:(e,t,n)=>{function o(){return"Notification"in window}function i(){return o()&&"granted"===Notification.permission}async function r(){if(!o())return null;try{return await Notification.requestPermission()}catch(e){return console.warn("Failed to request notification permission:",e),null}}function c(){return o()?Notification.permission:null}function a(e,t){if(!i())return null;try{return new Notification(e,t)}catch(e){return console.warn("Failed to show browser notification:",e),null}}n.d(t,{KO:()=>o,cn:()=>i,dL:()=>a,hH:()=>c,mT:()=>r})}}]);